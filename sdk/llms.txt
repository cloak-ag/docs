# Cloak SDK - AI Indexing Reference

> This file is optimized for LLM consumption. Use this to understand the Cloak SDK for private Solana transactions.

## Package Information

- **Name**: @cloak.ag/sdk
- **Version**: 1.0.x
- **License**: Apache-2.0
- **Repository**: https://github.com/cloak-ag/sdk
- **Documentation**: https://docs.cloak.ag/sdk

## Installation

```bash
npm install @cloak.ag/sdk @solana/web3.js
```

## Quick Start

```typescript
import { CloakSDK, getDistributableAmount } from "@cloak.ag/sdk";
import { Connection, Keypair, PublicKey } from "@solana/web3.js";

// CRITICAL: Devnet requires explicit program ID (SDK defaults to mainnet)
const DEVNET_PROGRAM_ID = new PublicKey("3EvH6XYQir7D2RyzCdP7QFmJFfSPfdeoB8VnpLdEF4Kr");
// Mainnet uses: c1oak6tetxYnNfvXKFkpn1d98FxtK7B68vBQLYQpWKp (default)

// Initialize
const sdk = new CloakSDK({
  keypairBytes: keypair.secretKey, // or wallet adapter
  network: "devnet",
  programId: DEVNET_PROGRAM_ID, // Required for devnet!
  debug: true, // Enable structured logging
});

// Deposit
const { note } = await sdk.deposit(connection, 100_000_000);

// Withdraw
await sdk.withdraw(connection, note, recipientPubkey, { withdrawAll: true });
```

## CRITICAL: Devnet vs Mainnet Configuration

| Network | Program ID | Notes |
|---------|------------|-------|
| Mainnet | `c1oak6tetxYnNfvXKFkpn1d98FxtK7B68vBQLYQpWKp` | SDK default |
| Devnet | `3EvH6XYQir7D2RyzCdP7QFmJFfSPfdeoB8VnpLdEF4Kr` | Must set `programId`! |

**Common Error**: If you get `0x1001 RootNotFound` on devnet, you forgot to set `programId`.

## Core Concepts

### CloakNote
A cryptographic commitment representing deposited SOL. Contains secrets needed to withdraw.

**SECURITY**: Never log or expose CloakNote objects - they contain spending secrets.

```typescript
interface CloakNote {
  version: string;
  amount: number;         // lamports
  commitment: string;     // Poseidon hash (hex)
  sk_spend: string;       // SPENDING SECRET (hex)
  r: string;              // RANDOMNESS SECRET (hex)
  timestamp: number;
  network: "devnet" | "mainnet" | "localnet" | "testnet";
  leafIndex?: number;     // Set after deposit
  depositSignature?: string;
  root?: string;          // Merkle root at deposit time
  merkleProof?: MerkleProof; // Computed from on-chain state
}
```

### Fees
- Fixed: 0.003 SOL per withdrawal
- Variable: 0.5% of deposit amount

```typescript
import { getDistributableAmount, calculateFee } from "@cloak.ag/sdk";
const afterFees = getDistributableAmount(depositAmount);
```

## Main Methods

### CloakSDK.deposit()
```typescript
await sdk.deposit(connection: Connection, amountOrNote: number | CloakNote, options?: {
  onNoteGenerated?: (note: CloakNote) => Promise<void>; // CRITICAL: Save note here
  onProgress?: (status: string) => void;
  skipPreflight?: boolean;
  computeUnits?: number;
  priorityFee?: number;
  optimizeCU?: boolean; // Node.js only: simulate for optimal CU
  loadedAccountsDataSizeLimit?: number;
}): Promise<{ note: CloakNote; signature: string; leafIndex: number; root: string; }>
```

### CloakSDK.withdraw()
```typescript
await sdk.withdraw(connection: Connection, note: CloakNote, recipient: PublicKey, options?: {
  withdrawAll?: boolean;
  amount?: number;
  onProgress?: (status: string) => void;
}): Promise<{ signature: string; outputs: Array<{recipient: string; amount: number}>; nullifier: string; root: string; }>
```

### CloakSDK.send()
```typescript
await sdk.send(connection: Connection, note: CloakNote, recipients: Array<{
  recipient: PublicKey;
  amount: number;
}>, options?: TransferOptions): Promise<TransferResult>
```
Max 5 recipients. Sum must equal getDistributableAmount(note.amount).

### CloakSDK.swap()
```typescript
await sdk.swap(connection: Connection, note: CloakNote, recipient: PublicKey, options: {
  outputMint: string;
  slippageBps?: number;
  minOutputAmount?: number;
  getQuote?: (amount, mint, slippage) => Promise<{ outAmount, minOutputAmount }>;
  recipientAta?: string; // Pre-computed ATA for browser environments
}): Promise<SwapResult>
```

### CloakSDK.getMerkleProof()
```typescript
await sdk.getMerkleProof(connection: Connection, leafIndex: number): Promise<MerkleProof>
```
Computes Merkle proof directly from on-chain state (no indexer needed).

### CloakSDK.getCurrentRoot()
```typescript
await sdk.getCurrentRoot(connection: Connection): Promise<string>
```
Gets current Merkle root from on-chain state.

### CloakSDK.generateNote()
```typescript
await sdk.generateNote(amountLamports: number, useWalletKeys?: boolean): Promise<CloakNote>
```
Generate a note without depositing. Pass note to deposit() later.

## Error Handling

```typescript
import { CloakError, ShieldPoolErrors, isRootNotFoundError } from "@cloak.ag/sdk";

try {
  await sdk.withdraw(...);
} catch (error) {
  if (error instanceof CloakError) {
    // error.category: "wallet" | "network" | "prover" | "relay" | "validation" | "environment"
    // error.retryable: boolean
  }
  
  // Check for stale Merkle root (SDK retries automatically)
  if (isRootNotFoundError(error)) {
    console.log("Root expired, proof needs refresh");
  }
}
```

## Common Error Codes (ShieldPoolErrors)

| Code | Name | Description |
|------|------|-------------|
| 0x1001 | RootNotFound | Merkle root not in history (stale proof) |
| 0x1010 | ProofInvalid | ZK proof verification failed |
| 0x1020 | DoubleSpend | Note already spent |
| 0x1030 | OutputsMismatch | Outputs don't match proof |
| 0x1058 | InsufficientLamports | Not enough SOL in pool |
| 0x1076 | ProofVerificationFailed | Groth16 verification failed |

Use `ShieldPoolErrors[code]` to get user-friendly messages.

## Browser Integration (React)

```typescript
import { useWallet, useConnection } from "@solana/wallet-adapter-react";

const { publicKey, signTransaction, sendTransaction } = useWallet();
const { connection } = useConnection();

const sdk = new CloakSDK({
  wallet: { publicKey, signTransaction, sendTransaction },
  network: "devnet",
});
```

## Circuit Files (Browser)
Serve from /public/circuits/:
- withdraw_regular.wasm
- withdraw_regular_final.zkey
- withdraw_swap.wasm  
- withdraw_swap_final.zkey

## Key Security Patterns

1. Always use onNoteGenerated to persist notes BEFORE deposit:
```typescript
await sdk.deposit(connection, amount, {
  onNoteGenerated: async (note) => {
    await saveNoteSecurely(note); // MUST complete before deposit proceeds
  },
});
```

2. Never log CloakNote objects
3. Store notes in encrypted storage
4. Check note.leafIndex before withdraw

## Utility Exports

```typescript
// Fee calculations
getDistributableAmount(amount: number): number
calculateFee(amount: number): number

// Crypto
computeCommitment(amount: bigint, r: bigint, sk: bigint): Promise<bigint>
computeNullifierAsync(sk_spend: string, leafIndex: number): Promise<bigint>

// On-chain proof (no indexer needed)
computeProofFromChain(connection, merkleTreePDA, leafIndex): Promise<OnchainMerkleProof>
readMerkleTreeState(connection, merkleTreePDA): Promise<{ root, nextIndex, ... }>

// Validation
isValidSolanaAddress(address: string): boolean
validateNote(note: CloakNote): void

// Network
getExplorerUrl(signature: string, network: Network): string

// Logging
createLogger(module: string): Logger
setDebugMode(enabled: boolean): void
withTiming(log, name, fn): Promise<{ result, durationMs }>
formatSol(lamports: number): string
truncate(str: string): string

// Keys (v2.0)
generateCloakKeys(): CloakKeyPair
exportKeys(keys: CloakKeyPair): string
importKeys(json: string): CloakKeyPair
```

## Architecture

The SDK computes Merkle proofs directly from on-chain state, eliminating the need for an external indexer:

1. **Deposit**: SDK sends transaction, parses leaf index from logs, computes proof from on-chain tree
2. **Withdraw**: SDK uses stored proof or computes fresh proof, generates ZK proof, submits to relay
3. **Relay**: Verifies proof on-chain and executes transfer to recipient

---

For complete documentation, see: https://docs.cloak.ag/sdk

