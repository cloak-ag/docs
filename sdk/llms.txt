# Cloak SDK - LLM Reference (v2)

This file is optimized for AI agents that need current SDK behavior.

## Package

- Name: `@cloak.ag/sdk`
- Version: `2.0.0`
- Node: `>=18`
- Mainnet program constant (`CLOAK_PROGRAM_ID`): `c1oak6tetxYnNfvXKFkpn1d98FxtK7B68vBQLYQpWKp`
- Development build program ID (from on-chain crate feature): `3EvH6XYQir7D2RyzCdP7QFmJFfSPfdeoB8VnpLdEF4Kr`

## APIs

### 1) Note-based API (`CloakSDK`)

Core methods:

- `deposit(connection, amountOrNote, options?)`
- `withdraw(connection, note, recipient, options?)`
- `send(connection, note, recipients, options?)`
- `swap(connection, note, recipient, options)`

Also:

- `privateTransfer(...)`
- `generateNote(...)`
- `getMerkleProof(...)`
- `getCurrentRoot(...)`
- `getTransactionStatus(...)`
- local storage/key helpers (`loadNotes`, `saveNote`, `findNote`, `importWalletKeys`, `exportWalletKeys`)

### 2) UTXO API (top-level exports)

- `transact(params, options)`
- `transfer(...)`
- `partialWithdraw(...)`
- `fullWithdraw(...)`
- `swapUtxo(params, options)`
- `swapWithChange(...)`

UTXO primitives:

- `generateUtxoKeypair`
- `createUtxo`
- `createZeroUtxo`
- `computeUtxoCommitment`
- `computeUtxoNullifier`

## External amount semantics (UTXO)

- `externalAmount > 0`: deposit
- `externalAmount < 0`: withdrawal
- `externalAmount = 0`: shield-to-shield transfer

## Fee constants (shared across SDK/program/relay)

- `FIXED_FEE_LAMPORTS = 5_000_000`
- Variable fee = `amount * 3 / 1000` (0.3%)
- `MIN_DEPOSIT_LAMPORTS = 10_000_000`
- `getDistributableAmount(amount) = amount - calculateFee(amount)`

## Error model

- `CloakError` categories include: `network | indexer | prover | relay | validation | wallet | environment`
- `ShieldPoolErrors` maps on-chain custom codes
- `RootNotFoundError` / `isRootNotFoundError` used for stale Merkle root (`0x1001`) handling
- `parseError` returns user-oriented `UserFriendlyError`

## Relay integration

The SDK uses relay routes such as:

- `POST /withdraw` (note-based)
- `POST /transact` (UTXO transact)
- `POST /transact_swap` (UTXO swap)
- `GET /status/:id`

Supporting endpoints often used by SDK tooling:

- `GET /commitments`
- `GET /merkle-root`

## Risk-oracle deposits

UTXO deposit flows may require Range/Switchboard quote instructions:

- Set `riskOracleQueue`
- Provide `riskQuoteUrl` (or `getRiskQuoteInstruction`)
- Use `addressLookupTableAccounts` for large V0 transactions when needed

## Proof and circuits

- Note and UTXO flows both require Groth16 proof generation.
- Browser deployments should serve circuits under `/circuits`.
- Node can use `CIRCUITS_PATH` / SDK circuit path helpers.

## Important caution for AI-generated code

- Preserve `bigint` usage in UTXO APIs.
- Do not assume devnet program ID equals `CLOAK_PROGRAM_ID`; set `programId` explicitly when using development deployments.
- Never log full note/UTXO secret material in production.
